<!DOCTYPE html>
<html>
<head>
  <title>rat reporter</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="exp.css">

<body>
  <div class="header">
    <h1 class="app-title">Rat Reporter</h1>
  </div>
  <div class="topnav" id="myTopnav">
    <a href="index.html" class="active">Home</a> 
    <a href="311tab.html">311</a>
    <a href="history.html">History</a>
    <a href="friends.html">Friends</a>
    <a href="javascript:void(0);" class="icon" onclick="myFunction()">&#9776;</a>
  </div>

  <div class="header2">
    <h1>Rat Reporter</h1>
  </div>

  <div class="row">
    <div class="col-3 col-s-3 menu">
      <div class="garbage-timer">
        <h3>Time until garbage truck arrives:</h3>
        <p id="garbage-countdown"><span id="hours-remaining">Loading...</span></p>
        <p class="timer-note">The closer you put trash out to garbage truck coming, the more ELO you gain.</p>
      </div>
    </div>
  
    <div class="col-6 col-s-9 rank-container">
      <div class="rank-display">
        <img id="rank-icon" src="rank_icons/Season_2023_-_Silver.png" alt="Rank Icon" class="rank-img">
        <div class="elo-rating">
          <h3>ELO Rating</h3>
          <p id="elo-value">1200</p>
        </div>
        <button id="garbage-button" class="action-button">Put Garbage Out</button>
      </div>
    </div>

    <div class="col-3 col-s-12">
      <div class="aside">
        <h1>Rats Mitigated:</h1>
        <p id="rats-count">100000</p>
        <div id="chat-popup" class="chat-button">
          <i class="fa fa-comments"></i> Chat
        </div>
      </div>
    </div>
  </div>
    
  

  



  <!-- Camera Modal -->
  <div id="camera-modal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>Take a Photo of Your Garbage</h2>
      <div class="camera-container">
        <video id="camera-view" autoplay playsinline></video>
        <canvas id="camera-canvas" style="display:none;"></canvas>
      </div>
      <div class="camera-controls">
        <button id="camera-capture">Take Photo</button>
        <button id="photo-save" disabled>Save Photo</button>
      </div>
    </div>
  </div>

  <script>
    // API URL - change this to your backend URL when deployed
    const API_URL = 'http://localhost:5000/api';
    
    // Current user ID (in a real app, this would come from authentication)
    const CURRENT_USER_ID = 1;
    
    // Navigation function
    function myFunction() {
      var x = document.getElementById("myTopnav");
      if (x.className === "topnav") {
        x.className += " responsive";
      } else {
        x.className = "topnav";
      }
    }

    // Fetch garbage time from API
    async function updateGarbageTimer() {
      try {
        const response = await fetch(`${API_URL}/garbage-time`);
        const data = await response.json();
        
        const hours = Math.floor(data.hours_until_pickup);
        const minutes = Math.round((data.hours_until_pickup - hours) * 60);
        
        document.getElementById('hours-remaining').textContent = 
          `${hours} hours, ${minutes} minutes`;
          
        // Store for later use
        window.hoursUntilPickup = data.hours_until_pickup;
      } catch (error) {
        console.error('Error fetching garbage time:', error);
        // Fallback to client-side calculation if API fails
        calculateGarbageTimeLocally();
      }
    }
    
    // Fallback function for calculating garbage time locally
    function calculateGarbageTimeLocally() {
      const now = new Date();
      let nextTuesday = new Date();
      
      // Set to next Tuesday
      nextTuesday.setDate(now.getDate() + ((9 - now.getDay()) % 7));
      
      // Set to 1 PM
      nextTuesday.setHours(13, 0, 0, 0);
      
      // If it's already past 1 PM on Tuesday, go to next week
      if (now > nextTuesday) {
        nextTuesday.setDate(nextTuesday.getDate() + 7);
      }
      
      // Calculate difference in hours
      const diffMs = nextTuesday - now;
      const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
      const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
      
      document.getElementById('hours-remaining').textContent = 
        `${diffHrs} hours, ${diffMins} minutes`;
        
      // Store for later use
      window.hoursUntilPickup = diffHrs + (diffMins / 60);
    }

    // Initialize garbage timer
    updateGarbageTimer();
    // Update every minute
    setInterval(updateGarbageTimer, 60000);

    // Fetch user data from API
    async function loadUserData() {
      try {
        const response = await fetch(`${API_URL}/user/${CURRENT_USER_ID}`);
        if (!response.ok) {
          throw new Error('Failed to fetch user data');
        }
        
        const userData = await response.json();
        
        // Update UI with user data
        document.getElementById('elo-value').textContent = userData.elo_rating;
        document.getElementById('rats-count').textContent = userData.disposals_count;
        
        // Update rank icon
        updateRankIcon(userData.elo_rating);
      } catch (error) {
        console.error('Error loading user data:', error);
        // Fallback to localStorage if API fails
        loadUserDataFromLocalStorage();
      }
    }
    
    // Fallback function for loading user data from localStorage
    function loadUserDataFromLocalStorage() {
      const savedElo = localStorage.getItem('userElo') || '1200';
      document.getElementById('elo-value').textContent = savedElo;
      updateRankIcon(parseInt(savedElo));
    }

    // Chat popup functionality
    document.getElementById('chat-popup').addEventListener('click', function() {
      window.location.href = '311tab.html';
    });

    // Camera functionality
    const cameraModal = document.getElementById('camera-modal');
    const cameraView = document.getElementById('camera-view');
    const cameraCanvas = document.getElementById('camera-canvas');
    const captureButton = document.getElementById('camera-capture');
    const saveButton = document.getElementById('photo-save');
    const closeButton = document.querySelector('.close-button');
    let stream = null;
    let capturedPhoto = null;

    // Open camera modal
    document.getElementById('garbage-button').addEventListener('click', function() {
      cameraModal.style.display = 'block';
      startCamera();
    });

    // Close camera modal
    closeButton.addEventListener('click', function() {
      cameraModal.style.display = 'none';
      stopCamera();
    });

    // Start camera
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        cameraView.srcObject = stream;
        saveButton.disabled = true;
      } catch (err) {
        console.error("Error accessing camera: ", err);
        alert("Could not access camera. Please check permissions.");
      }
    }

    // Stop camera
    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
    }

    // Capture photo
    captureButton.addEventListener('click', function() {
      const context = cameraCanvas.getContext('2d');
      cameraCanvas.width = cameraView.videoWidth;
      cameraCanvas.height = cameraView.videoHeight;
      context.drawImage(cameraView, 0, 0, cameraCanvas.width, cameraCanvas.height);
      capturedPhoto = cameraCanvas.toDataURL('image/png');
      saveButton.disabled = false;
    });

    // Save photo
    saveButton.addEventListener('click', async function() {
      if (!capturedPhoto) return;
      
      try {
        // First, calculate potential ELO gain
        const eloResponse = await fetch(`${API_URL}/photos/elo`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            hours_until_pickup: window.hoursUntilPickup || 24
          })
        });
        
        const eloData = await eloResponse.json();
        
        // Upload photo to API
        const uploadResponse = await fetch(`${API_URL}/photos/upload`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            user_id: CURRENT_USER_ID,
            photo: capturedPhoto
          })
        });
        
        if (!uploadResponse.ok) {
          throw new Error('Failed to upload photo');
        }
        
        const photoData = await uploadResponse.json();
        
        // Update user's ELO
        await fetch(`${API_URL}/user/${CURRENT_USER_ID}/elo`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            elo_change: eloData.elo_gain
          })
        });
        
        // Reload user data to update UI
        await loadUserData();
        
        // Close modal
        cameraModal.style.display = 'none';
        stopCamera();
        
        // Show success message
        alert(`Photo saved! ${eloData.message} You gained ${eloData.elo_gain} ELO points.`);
      } catch (error) {
        console.error('Error saving photo:', error);
        
        // Fallback to localStorage if API fails
        savePhotoToLocalStorage();
      }
    });
    
    // Fallback function for saving photo to localStorage
    function savePhotoToLocalStorage() {
      // Save to local storage
      const timestamp = new Date().toISOString();
      const photos = JSON.parse(localStorage.getItem('garbagePhotos') || '[]');
      photos.push({
        id: Date.now(),
        data: capturedPhoto,
        timestamp: timestamp
      });
      localStorage.setItem('garbagePhotos', JSON.stringify(photos));
      
      // Update ELO based on timing
      updateEloForGarbageDisposal();
      
      // Close modal
      cameraModal.style.display = 'none';
      stopCamera();
      
      alert('Photo saved! Check the History tab to view it.');
    }

    // ELO calculation based on garbage timing (fallback function)
    function updateEloForGarbageDisposal() {
      // Get current ELO
      let currentElo = parseInt(document.getElementById('elo-value').textContent);
      
      // Calculate bonus based on timing
      const hoursUntilPickup = window.hoursUntilPickup || 24;
      
      // More points for putting garbage out closer to pickup time
      let eloBonus = 0;
      if (hoursUntilPickup <= 2) {
        eloBonus = 50; // Very close to pickup time
      } else if (hoursUntilPickup <= 12) {
        eloBonus = 30; // Same day
      } else if (hoursUntilPickup <= 24) {
        eloBonus = 15; // Day before
      } else {
        eloBonus = 5; // Way too early
      }
      
      // Update ELO
      currentElo += eloBonus;
      document.getElementById('elo-value').textContent = currentElo;
      localStorage.setItem('userElo', currentElo);
      
      // Update rank based on new ELO
      updateRankIcon(currentElo);
    }

    // Update rank icon based on ELO
    function updateRankIcon(elo) {
      let rankIcon = '';
      
      if (elo < 800) {
        rankIcon = 'Season_2023_-_Iron.png';
      } else if (elo < 1200) {
        rankIcon = 'Season_2023_-_Silver.png';
      } else if (elo < 1600) {
        rankIcon = 'Season_2023_-_Gold.png';
      } else if (elo < 2000) {
        rankIcon = 'Season_2023_-_Platinum.png';
      } else if (elo < 2400) {
        rankIcon = 'Season_2023_-_Emerald.png';
      } else if (elo < 2800) {
        rankIcon = 'Season_2023_-_Challenger.png';
      } else {
        rankIcon = 'Season_2023_-_Grandmaster.png';
      }
      
      document.getElementById('rank-icon').src = 'rank_icons/' + rankIcon;
    }

    // Load user data on page load
    window.addEventListener('load', function() {
      loadUserData();
    });
  </script>
    
  <footer>
    <p>rat reporter</p>
    <div class="footer-links">
      <a href="https://www.boston.gov/" class="footer-button" target="_blank">Boston.gov</a>
      <a href="https://www.boston.gov/departments/inspectional-services/boston-rodent-action-plan" class="footer-button" target="_blank">Rodent Action Plan</a>
      <a href="https://www.nrdc.org/stories/composting-101" class="footer-button" target="_blank">Composting 101</a>
    </div>
  </footer>
</body>
</html>
